<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precificação de Emendas - Ministério do Esporte</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>~
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background-color: #e9ecef;
            color: #2d3748;
        }

        .header {
            background-color: #003087;
            color: white;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .logo {
            height: 60px;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

        h1, h2 {
            color: #003087;
            margin-bottom: 30px;
            font-weight: 700;
        }

        h1 {
            text-align: center;
            font-size: 28px;
        }

        .resumo-valores {
            background-color: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 40px;
            border-left: 5px solid #003087;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .resumo-valores p {
            margin: 5px 0;
            min-width: 200px;
            font-size: 16px;
        }

        .resumo-valores span {
            font-weight: bold;
            color: #003087;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: 2px solid transparent;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            background-color: #f1f1f1;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .tab.active {
            background-color: white;
            border-color: #e2e8f0;
            border-bottom-color: white;
            color: #003087;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .formulario-item {
            background-color: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: #003087;
            font-size: 16px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #003087;
        }

        .form-group input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .empresas-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .empresa {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .empresa h4 {
            margin-bottom: 10px;
            color: #003087;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 5px;
            font-size: 18px;
        }

        .btn {
            background-color: #003087;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.2s;
        }

        .btn:hover {
            background-color: #00205b;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: #16a34a;
        }

        .btn-success:hover {
            background-color: #15803d;
        }

        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .carrinho {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 8px;
            max-width: 1200px;
            margin-left: 0 !important; /* Força o alinhamento à esquerda */
            margin-right: 0 !important;
            width: 100%; /* Garante que o carrinho ocupe toda a largura disponível à esquerda */
            box-sizing: border-box;
        }


        .carrinho h3 {
            color: #003087;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .carrinho-vazio {
            color: #6b7280;
            padding: 20px;
            text-align: center;
        }
        .item-carrinho {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            align-items: center;
            text-align: left; /* Alinha o texto à esquerda */
            width: 100%; /* Garante que o item ocupe a largura total */
        }

        .item-carrinho-info {
            flex: 1;
            text-align: left; /* Garante que o texto dentro desta div esteja à esquerda */
        }

        .item-carrinho-info p,
        .item-carrinho-info span {
            text-align: left;
            display: block; /* Para garantir que cada linha de texto comece à esquerda */
        }

        .item-carrinho-acoes button {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .total-carrinho {
            margin-top: 15px;
            font-weight: bold;
            font-size: 18px;
            color: #003087;
        }

        .acoes-carrinho {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }

        .declaracao-container {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .declaracao-container label {
            font-size: 14px;
            color: #4b5563;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #6b7280;
            font-size: 14px;
        }

        .suggestions {
            position: absolute;
            background: white;
            border: 1px solid #e2e8f0;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 1000;
            border-radius: 4px;
        }

        .suggestion-item {
            padding: 10px;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background-color: #f0f0f0;
        }

        .error-message {
            color: #dc2626;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                margin: 20px;
                padding: 20px;
            }

            .empresas-container {
                grid-template-columns: 1fr;
            }

            .resumo-valores {
                flex-direction: column;
            }

            .header {
                padding: 15px 20px;
            }

            .logo {
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <img src="/images/ASSINATURAS_ESPORTE__PRINCIPAL.png" alt="Ministério do Esporte" class="logo">
        <h2>Sistema de Precificação de Emendas</h2>
    </header>

    <div class="container">
        <h1>Precificação de Itens</h1>

        <div class="resumo-valores">
            <p><span>Valor Total da Emenda:</span> <strong id="valor-total">R$ 0,00</strong></p>
            <p><span>Valor Gasto:</span> <strong id="valor-gasto">R$ 0,00</strong></p>
            <p><span>Valor Restante:</span> <strong id="valor-restante">R$ 0,00</strong></p>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="servicos">Serviços/Recursos Humanos</div>
            <div class="tab" data-tab="material-esportivo">Material Esportivo</div>
            <div class="tab" data-tab="uniformes">Uniformes</div>
            <div class="tab" data-tab="identidades-divulgacoes">Identidades/Divulgações</div>
            <div class="tab" data-tab="alimentacao">Alimentação</div>
        </div>

        <!-- Serviços -->
        <div id="servicos" class="tab-content active">
            <div class="formulario-item">
                <h2>Adicionar Item - Serviços/Recursos Humanos</h2>
                <div class="form-group">
                    <label for="srv-cargo">Serviço</label>
                    <select id="srv-cargo" onchange="toggleOutrosField('srv')">
                        <option value="">Selecione um cargo</option>
                    </select>
                </div>
                <div class="form-group" id="srv-outros-container" style="display: none;">
                    <label for="srv-outros">Especifique o Serviço</label>
                    <input type="text" id="srv-outros" placeholder="Digite o serviço">
                </div>
                <div class="form-group">
                    <label for="srv-descricao">Descrição do Serviço/Método de Cálculo</label>
                    <textarea id="srv-descricao" placeholder="Ex: PROFESSOR - Responsável pela preparação e execução das aulas"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label for="srv-quantidade">Quantidade</label>
                        <input type="number" id="srv-quantidade" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="srv-periodo">Diárias/Meses</label>
                        <select id="srv-periodo">
                            <option value="diarias">Diárias</option>
                            <option value="meses">Meses</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="srv-periodo-valor">Período</label>
                        <input type="number" id="srv-periodo-valor" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="srv-total">Total</label>
                        <input type="number" id="srv-total" readonly>
                    </div>
                </div>
                <h3 style="margin-top: 20px;">Empresas Cotadas</h3>
                <div class="empresas-container">
                    <div class="empresa">
                        <h4>Empresa 1</h4>
                        <div class="form-group">
                            <label for="srv-empresa1-nome">Nome</label>
                            <input type="text" id="srv-empresa1-nome" placeholder="Nome da empresa">
                        </div>
                        <div class="form-group">
                            <label for="srv-empresa1-cnpj">CNPJ</label>
                            <input type="text" id="srv-empresa1-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label for="srv-empresa1-link">Link</label>
                            <input type="url" id="srv-empresa1-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="srv-empresa1-unitario">Valor Unitário (R$)</label>
                            <input type="text" id="srv-empresa1-unitario" class="valor-monetario" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="srv-empresa1-total">Valor Total (R$)</label>
                            <input type="text" id="srv-empresa1-total" readonly>
                        </div>
                        <div class="form-group">
                            <label for="srv-empresa1-selecionada">Selecionar Empresa</label>
                            <input type="radio" name="srv-empresa-selecionada" id="srv-empresa1-selecionada" value="1" onchange="mostrarJustificativa('srv', 1)">
                        </div>
                    </div>
                    <div class="empresa">
                        <h4>Empresa 2</h4>
                        <div class="form-group">
                            <label for="srv-empresa2-nome">Nome</label>
                            <input type="text" id="srv-empresa2-nome" placeholder="Nome da empresa">
                        </div>
                        <div class="form-group">
                            <label for="srv-empresa2-cnpj">CNPJ</label>
                            <input type="text" id="srv-empresa2-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label for="srv-empresa2-link">Link</label>
                            <input type="url" id="srv-empresa2-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="srv-empresa2-unitario">Valor Unitário (R$)</label>
                            <input type="text" id="srv-empresa2-unitario" class="valor-monetario" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="srv-empresa2-total">Valor Total (R$)</label>
                            <input type="text" id="srv-empresa2-total" readonly>
                        </div>
                        <div class="form-group">
                            <label for="srv-empresa2-selecionada">Selecionar Empresa</label>
                            <input type="radio" name="srv-empresa-selecionada" id="srv-empresa2-selecionada" value="2" onchange="mostrarJustificativa('srv', 2)">
                        </div>
                    </div>
                    <div class="empresa">
                        <h4>Empresa 3</h4>
                        <div class="form-group">
                            <label for="srv-empresa3-nome">Nome</label>
                            <input type="text" id="srv-empresa3-nome" placeholder="Nome da empresa">
                        </div>
                        <div class="form-group">
                            <label for="srv-empresa3-cnpj">CNPJ</label>
                            <input type="text" id="srv-empresa3-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label for="srv-empresa3-link">Link</label>
                            <input type="url" id="srv-empresa3-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="srv-empresa3-unitario">Valor Unitário (R$)</label>
                            <input type="text" id="srv-empresa3-unitario" class="valor-monetario" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="srv-empresa3-total">Valor Total (R$)</label>
                            <input type="text" id="srv-empresa3-total" readonly>
                        </div>
                        <div class="form-group">
                            <label for="srv-empresa3-selecionada">Selecionar Empresa</label>
                            <input type="radio" name="srv-empresa-selecionada" id="srv-empresa3-selecionada" value="3" onchange="mostrarJustificativa('srv', 3)">
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="srv-menor-valor">Menor Valor Cotado (R$)</label>
                    <input type="text" id="srv-menor-valor" readonly>
                </div>
                <div class="form-group" id="srv-justificativa-container" style="display: none;">
                    <label for="srv-justificativa">Justificativa</label>
                    <textarea id="srv-justificativa" placeholder="Justifique a escolha de uma empresa com valor superior ao menor cotado"></textarea>
                </div>
                <button class="btn btn-success" id="srv-adicionar-carrinho">Adicionar ao Carrinho</button>
            </div>
        </div>

        <!-- Material Esportivo -->
        <div id="material-esportivo" class="tab-content">
            <div class="formulario-item">
                <h2>Adicionar Item - Material Esportivo</h2>
                <div class="form-group">
                    <label for="me-tipo">Tipo</label>
                    <select id="me-tipo" onchange="toggleLocacaoFields()">
                        <option value="aquisicao">Aquisição</option>
                        <option value="locacao">Locação</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="me-item">Item</label>
                    <input type="text" id="me-item" oninput="filtrarItens('me')" placeholder="Digite o item">
                    <div id="me-item-suggestions" class="suggestions" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <label for="me-subitem">Subitem</label>
                    <input type="text" id="me-subitem" oninput="filtrarSubitens('me')" placeholder="Digite o subitem">
                    <div id="me-subitem-suggestions" class="suggestions" style="display: none;"></div>
                </div>
                <div class="form-group" id="me-outros-container" style="display: none;">
                    <label for="me-outros">Especifique o Item</label>
                    <input type="text" id="me-outros" placeholder="Digite o item">
                </div>
                <div class="form-group">
                    <label for="me-descricao">Descrição do Item</label>
                    <textarea id="me-descricao" placeholder="Descreva o item"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label for="me-quantidade">Quantidade</label>
                        <input type="number" id="me-quantidade" min="1" value="1">
                    </div>
                    <div class="form-group" id="me-periodo-container">
                        <label for="me-periodo">Diárias/Meses</label>
                        <select id="me-periodo">
                            <option value="diarias">Diárias</option>
                            <option value="meses">Meses</option>
                        </select>
                    </div>
                    <div class="form-group" id="me-periodo-valor-container">
                        <label for="me-periodo-valor">Período</label>
                        <input type="number" id="me-periodo-valor" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="me-total">Total</label>
                        <input type="number" id="me-total" readonly>
                    </div>
                </div>
                <h3 style="margin-top: 20px;">Empresas Cotadas</h3>
                <div class="empresas-container">
                    <div class="empresa">
                        <h4>Empresa 1</h4>
                        <div class="form-group">
                            <label for="me-empresa1-nome">Nome</label>
                            <input type="text" id="me-empresa1-nome" placeholder="Nome da empresa">
                        </div>
                        <div class="form-group">
                            <label for="me-empresa1-cnpj">CNPJ</label>
                            <input type="text" id="me-empresa1-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label for="me-empresa1-link">Link</label>
                            <input type="url" id="me-empresa1-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="me-empresa1-unitario">Valor Unitário (R$)</label>
                            <input type="text" id="me-empresa1-unitario" class="valor-monetario" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="me-empresa1-total">Valor Total (R$)</label>
                            <input type="text" id="me-empresa1-total" readonly>
                        </div>
                        <div class="form-group">
                            <label for="me-empresa1-selecionada">Selecionar Empresa</label>
                            <input type="radio" name="me-empresa-selecionada" id="me-empresa1-selecionada" value="1" onchange="mostrarJustificativa('me', 1)">
                        </div>
                    </div>
                    <div class="empresa">
                        <h4>Empresa 2</h4>
                        <div class="form-group">
                            <label for="me-empresa2-nome">Nome</label>
                            <input type="text" id="me-empresa2-nome" placeholder="Nome da empresa">
                        </div>
                        <div class="form-group">
                            <label for="me-empresa2-cnpj">CNPJ</label>
                            <input type="text" id="me-empresa2-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label for="me-empresa2-link">Link</label>
                            <input type="url" id="me-empresa2-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="me-empresa2-unitario">Valor Unitário (R$)</label>
                            <input type="text" id="me-empresa2-unitario" class="valor-monetario" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="me-empresa2-total">Valor Total (R$)</label>
                            <input type="text" id="me-empresa2-total" readonly>
                        </div>
                        <div class="form-group">
                            <label for="me-empresa2-selecionada">Selecionar Empresa</label>
                            <input type="radio" name="me-empresa-selecionada" id="me-empresa2-selecionada" value="2" onchange="mostrarJustificativa('me', 2)">
                        </div>
                    </div>
                    <div class="empresa">
                        <h4>Empresa 3</h4>
                        <div class="form-group">
                            <label for="me-empresa3-nome">Nome</label>
                            <input type="text" id="me-empresa3-nome" placeholder="Nome da empresa">
                        </div>
                        <div class="form-group">
                            <label for="me-empresa3-cnpj">CNPJ</label>
                            <input type="text" id="me-empresa3-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label for="me-empresa3-link">Link</label>
                            <input type="url" id="me-empresa3-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="me-empresa3-unitario">Valor Unitário (R$)</label>
                            <input type="text" id="me-empresa3-unitario" class="valor-monetario" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="me-empresa3-total">Valor Total (R$)</label>
                            <input type="text" id="me-empresa3-total" readonly>
                        </div>
                        <div class="form-group">
                            <label for="me-empresa3-selecionada">Selecionar Empresa</label>
                            <input type="radio" name="me-empresa-selecionada" id="me-empresa3-selecionada" value="3" onchange="mostrarJustificativa('me', 3)">
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="me-menor-valor">Menor Valor Cotado (R$)</label>
                    <input type="text" id="me-menor-valor" readonly>
                </div>
                <div class="form-group" id="me-justificativa-container" style="display: none;">
                    <label for="me-justificativa">Justificativa</label>
                    <textarea id="me-justificativa" placeholder="Justifique a escolha de uma empresa com valor superior ao menor cotado"></textarea>
                </div>
                <button class="btn btn-success" id="me-adicionar-carrinho">Adicionar ao Carrinho</button>
            </div>
        </div>

        <!-- Uniformes -->
        <div id="uniformes" class="tab-content">
            <div class="formulario-item">
                <h2>Adicionar Item - Uniformes</h2>
                <div class="form-group">
                    <label for="uni-item">Item</label>
                    <input type="text" id="uni-item" oninput="filtrarItens('uni')" placeholder="Digite o item">
                    <div id="uni-item-suggestions" class="suggestions" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <label for="uni-subitem">Subitem</label>
                    <input type="text" id="uni-subitem" oninput="filtrarSubitens('uni')" placeholder="Digite o subitem">
                    <div id="uni-subitem-suggestions" class="suggestions" style="display: none;"></div>
                </div>
                <div class="form-group" id="uni-outros-container" style="display: none;">
                    <label for="uni-outros">Especifique o Item</label>
                    <input type="text" id="uni-outros" placeholder="Digite o item">
                </div>
                <div class="form-group">
                    <label for="uni-descricao">Descrição do Item</label>
                    <textarea id="uni-descricao" placeholder="Descreva o item"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label for="uni-quantidade">Quantidade</label>
                        <input type="number" id="uni-quantidade" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="uni-periodo">Diárias/Meses</label>
                        <select id="uni-periodo">
                            <option value="diarias">Diárias</option>
                            <option value="meses">Meses</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="uni-periodo-valor">Período</label>
                        <input type="number" id="uni-periodo-valor" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="uni-total">Total</label>
                        <input type="number" id="uni-total" readonly>
                    </div>
                </div>
                <h3 style="margin-top: 20px;">Empresas Cotadas</h3>
                <div class="empresas-container">
                    <div class="empresa">
                        <h4>Empresa 1</h4>
                        <div class="form-group">
                            <label for="uni-empresa1-nome">Nome</label>
                            <input type="text" id="uni-empresa1-nome" placeholder="Nome da empresa">
                        </div>
                        <div class="form-group">
                            <label for="uni-empresa1-cnpj">CNPJ</label>
                            <input type="text" id="uni-empresa1-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label for="uni-empresa1-link">Link</label>
                            <input type="url" id="uni-empresa1-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="uni-empresa1-unitario">Valor Unitário (R$)</label>
                            <input type="text" id="uni-empresa1-unitario" class="valor-monetario" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="uni-empresa1-total">Valor Total (R$)</label>
                            <input type="text" id="uni-empresa1-total" readonly>
                        </div>
                        <div class="form-group">
                            <label for="uni-empresa1-selecionada">Selecionar Empresa</label>
                            <input type="radio" name="uni-empresa-selecionada" id="uni-empresa1-selecionada" value="1" onchange="mostrarJustificativa('uni', 1)">
                        </div>
                    </div>
                    <div class="empresa">
                        <h4>Empresa 2</h4>
                        <div class="form-group">
                            <label for="uni-empresa2-nome">Nome</label>
                            <input type="text" id="uni-empresa2-nome" placeholder="Nome da empresa">
                        </div>
                        <div class="form-group">
                            <label for="uni-empresa2-cnpj">CNPJ</label>
                            <input type="text" id="uni-empresa2-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label for="uni-empresa2-link">Link</label>
                            <input type="url" id="uni-empresa2-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="uni-empresa2-unitario">Valor Unitário (R$)</label>
                            <input type="text" id="uni-empresa2-unitario" class="valor-monetario" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="uni-empresa2-total">Valor Total (R$)</label>
                            <input type="text" id="uni-empresa2-total" readonly>
                        </div>
                        <div class="form-group">
                            <label for="uni-empresa2-selecionada">Selecionar Empresa</label>
                            <input type="radio" name="uni-empresa-selecionada" id="uni-empresa2-selecionada" value="2" onchange="mostrarJustificativa('uni', 2)">
                        </div>
                    </div>
                    <div class="empresa">
                        <h4>Empresa 3</h4>
                        <div class="form-group">
                            <label for="uni-empresa3-nome">Nome</label>
                            <input type="text" id="uni-empresa3-nome" placeholder="Nome da empresa">
                        </div>
                        <div class="form-group">
                            <label for="uni-empresa3-cnpj">CNPJ</label>
                            <input type="text" id="uni-empresa3-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label for="uni-empresa3-link">Link</label>
                            <input type="url" id="uni-empresa3-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="uni-empresa3-unitario">Valor Unitário (R$)</label>
                            <input type="text" id="uni-empresa3-unitario" class="valor-monetario" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="uni-empresa3-total">Valor Total (R$)</label>
                            <input type="text" id="uni-empresa3-total" readonly>
                        </div>
                        <div class="form-group">
                            <label for="uni-empresa3-selecionada">Selecionar Empresa</label>
                            <input type="radio" name="uni-empresa-selecionada" id="uni-empresa3-selecionada" value="3" onchange="mostrarJustificativa('uni', 3)">
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="uni-menor-valor">Menor Valor Cotado (R$)</label>
                    <input type="text" id="uni-menor-valor" readonly>
                </div>
                <div class="form-group" id="uni-justificativa-container" style="display: none;">
                    <label for="uni-justificativa">Justificativa</label>
                    <textarea id="uni-justificativa" placeholder="Justifique a escolha de uma empresa com valor superior ao menor cotado"></textarea>
                </div>
                <button class="btn btn-success" id="uni-adicionar-carrinho">Adicionar ao Carrinho</button>
            </div>
        </div>

        <!-- Identidades/Divulgações -->
        <div id="identidades-divulgacoes" class="tab-content">
            <div class="formulario-item">
                <h2>Adicionar Item - Identidades/Divulgações</h2>
                <div class="form-group">
                    <label for="idv-item">Item</label>
                    <input type="text" id="idv-item" oninput="filtrarItens('idv')" placeholder="Digite o item">
                    <div id="idv-item-suggestions" class="suggestions" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <label for="idv-subitem">Subitem</label>
                    <input type="text" id="idv-subitem" oninput="filtrarSubitens('idv')" placeholder="Digite o subitem">
                    <div id="idv-subitem-suggestions" class="suggestions" style="display: none;"></div>
                </div>
                <div class="form-group" id="idv-outros-container" style="display: none;">
                    <label for="idv-outros">Especifique o Item</label>
                    <input type="text" id="idv-outros" placeholder="Digite o item">
                </div>
                <div class="form-group">
                    <label for="idv-descricao">Descrição do Item</label>
                    <textarea id="idv-descricao" placeholder="Descreva o item"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label for="idv-quantidade">Quantidade</label>
                        <input type="number" id="idv-quantidade" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="idv-periodo">Diárias/Meses</label>
                        <select id="idv-periodo">
                            <option value="diarias">Diárias</option>
                            <option value="meses">Meses</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="idv-periodo-valor">Período</label>
                        <input type="number" id="idv-periodo-valor" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="idv-total">Total</label>
                        <input type="number" id="idv-total" readonly>
                    </div>
                </div>
                <h3 style="margin-top: 20px;">Empresas Cotadas</h3>
                <div class="empresas-container">
                    <div class="empresa">
                        <h4>Empresa 1</h4>
                        <div class="form-group">
                            <label for="idv-empresa1-nome">Nome</label>
                            <input type="text" id="idv-empresa1-nome" placeholder="Nome da empresa">
                        </div>
                        <div class="form-group">
                            <label for="idv-empresa1-cnpj">CNPJ</label>
                            <input type="text" id="idv-empresa1-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label for="idv-empresa1-link">Link</label>
                            <input type="url" id="idv-empresa1-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="idv-empresa1-unitario">Valor Unitário (R$)</label>
                            <input type="text" id="idv-empresa1-unitario" class="valor-monetario" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="idv-empresa1-total">Valor Total (R$)</label>
                            <input type="text" id="idv-empresa1-total" readonly>
                        </div>
                        <div class="form-group">
                            <label for="idv-empresa1-selecionada">Selecionar Empresa</label>
                            <input type="radio" name="idv-empresa-selecionada" id="idv-empresa1-selecionada" value="1" onchange="mostrarJustificativa('idv', 1)">
                        </div>
                    </div>
                    <div class="empresa">
                        <h4>Empresa 2</h4>
                        <div class="form-group">
                            <label for="idv-empresa2-nome">Nome</label>
                            <input type="text" id="idv-empresa2-nome" placeholder="Nome da empresa">
                        </div>
                        <div class="form-group">
                            <label for="idv-empresa2-cnpj">CNPJ</label>
                            <input type="text" id="idv-empresa2-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label for="idv-empresa2-link">Link</label>
                            <input type="url" id="idv-empresa2-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="idv-empresa2-unitario">Valor Unitário (R$)</label>
                            <input type="text" id="idv-empresa2-unitario" class="valor-monetario" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="idv-empresa2-total">Valor Total (R$)</label>
                            <input type="text" id="idv-empresa2-total" readonly>
                        </div>
                        <div class="form-group">
                            <label for="idv-empresa2-selecionada">Selecionar Empresa</label>
                            <input type="radio" name="idv-empresa-selecionada" id="idv-empresa2-selecionada" value="2" onchange="mostrarJustificativa('idv', 2)">
                        </div>
                    </div>
                    <div class="empresa">
                        <h4>Empresa 3</h4>
                        <div class="form-group">
                            <label for="idv-empresa3-nome">Nome</label>
                            <input type="text" id="idv-empresa3-nome" placeholder="Nome da empresa">
                        </div>
                        <div class="form-group">
                            <label for="idv-empresa3-cnpj">CNPJ</label>
                            <input type="text" id="idv-empresa3-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label for="idv-empresa3-link">Link</label>
                            <input type="url" id="idv-empresa3-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="idv-empresa3-unitario">Valor Unitário (R$)</label>
                            <input type="text" id="idv-empresa3-unitario" class="valor-monetario" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="idv-empresa3-total">Valor Total (R$)</label>
                            <input type="text" id="idv-empresa3-total" readonly>
                        </div>
                        <div class="form-group">
                            <label for="idv-empresa3-selecionada">Selecionar Empresa</label>
                            <input type="radio" name="idv-empresa-selecionada" id="idv-empresa3-selecionada" value="3" onchange="mostrarJustificativa('idv', 3)">
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="idv-menor-valor">Menor Valor Cotado (R$)</label>
                    <input type="text" id="idv-menor-valor" readonly>
                </div>
                <div class="form-group" id="idv-justificativa-container" style="display: none;">
                    <label for="idv-justificativa">Justificativa</label>
                    <textarea id="idv-justificativa" placeholder="Justifique a escolha de uma empresa com valor superior ao menor cotado"></textarea>
                </div>
                <button class="btn btn-success" id="idv-adicionar-carrinho">Adicionar ao Carrinho</button>
            </div>
        </div>

        <!-- Alimentação -->
        <div id="alimentacao" class="tab-content">
            <div class="formulario-item">
                <h2>Adicionar Item - Alimentação</h2>
                <div class="form-group">
                    <label for="ali-item">Item</label>
                    <input type="text" id="ali-item" oninput="filtrarItens('ali')" placeholder="Digite o item">
                    <div id="ali-item-suggestions" class="suggestions" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <label for="ali-subitem">Subitem</label>
                    <input type="text" id="ali-subitem" oninput="filtrarSubitens('ali')" placeholder="Digite o subitem">
                    <div id="ali-subitem-suggestions" class="suggestions" style="display: none;"></div>
                </div>
                <div class="form-group" id="ali-outros-container" style="display: none;">
                    <label for="ali-outros">Especifique o Item</label>
                    <input type="text" id="ali-outros" placeholder="Digite o item">
                </div>
                <div class="form-group">
                    <label for="ali-descricao">Descrição do Item</label>
                    <textarea id="ali-descricao" placeholder="Descreva o item"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label for="ali-quantidade">Quantidade</label>
                        <input type="number" id="ali-quantidade" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="ali-periodo">Diárias/Meses</label>
                        <select id="ali-periodo">
                            <option value="diarias">Diárias</option>
                            <option value="meses">Meses</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ali-periodo-valor">Período</label>
                        <input type="number" id="ali-periodo-valor" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="ali-total">Total</label>
                        <input type="number" id="ali-total" readonly>
                    </div>
                </div>
                <h3 style="margin-top: 20px;">Empresas Cotadas</h3>
                <div class="empresas-container">
                    <div class="empresa">
                        <h4>Empresa 1</h4>
                        <div class="form-group">
                            <label for="ali-empresa1-nome">Nome</label>
                            <input type="text" id="ali-empresa1-nome" placeholder="Nome da empresa">
                        </div>
                        <div class="form-group">
                            <label for="ali-empresa1-cnpj">CNPJ</label>
                            <input type="text" id="ali-empresa1-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label for="ali-empresa1-link">Link</label>
                            <input type="url" id="ali-empresa1-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="ali-empresa1-unitario">Valor Unitário (R$)</label>
                            <input type="text" id="ali-empresa1-unitario" class="valor-monetario" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="ali-empresa1-total">Valor Total (R$)</label>
                            <input type="text" id="ali-empresa1-total" readonly>
                        </div>
                        <div class="form-group">
                            <label for="ali-empresa1-selecionada">Selecionar Empresa</label>
                            <input type="radio" name="ali-empresa-selecionada" id="ali-empresa1-selecionada" value="1" onchange="mostrarJustificativa('ali', 1)">
                        </div>
                    </div>
                    <div class="empresa">
                        <h4>Empresa 2</h4>
                        <div class="form-group">
                            <label for="ali-empresa2-nome">Nome</label>
                            <input type="text" id="ali-empresa2-nome" placeholder="Nome da empresa">
                        </div>
                        <div class="form-group">
                            <label for="ali-empresa2-cnpj">CNPJ</label>
                            <input type="text" id="ali-empresa2-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label for="ali-empresa2-link">Link</label>
                            <input type="url" id="ali-empresa2-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="ali-empresa2-unitario">Valor Unitário (R$)</label>
                            <input type="text" id="ali-empresa2-unitario" class="valor-monetario" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="ali-empresa2-total">Valor Total (R$)</label>
                            <input type="text" id="ali-empresa2-total" readonly>
                        </div>
                        <div class="form-group">
                            <label for="ali-empresa2-selecionada">Selecionar Empresa</label>
                            <input type="radio" name="ali-empresa-selecionada" id="ali-empresa2-selecionada" value="2" onchange="mostrarJustificativa('ali', 2)">
                        </div>
                    </div>
                    <div class="empresa">
                        <h4>Empresa 3</h4>
                        <div class="form-group">
                            <label for="ali-empresa3-nome">Nome</label>
                            <input type="text" id="ali-empresa3-nome" placeholder="Nome da empresa">
                        </div>
                        <div class="form-group">
                            <label for="ali-empresa3-cnpj">CNPJ</label>
                            <input type="text" id="ali-empresa3-cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label for="ali-empresa3-link">Link</label>
                            <input type="url" id="ali-empresa3-link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="ali-empresa3-unitario">Valor Unitário (R$)</label>
                            <input type="text" id="ali-empresa3-unitario" class="valor-monetario" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="ali-empresa3-total">Valor Total (R$)</label>
                            <input type="text" id="ali-empresa3-total" readonly>
                        </div>
                        <div class="form-group">
                            <label for="ali-empresa3-selecionada">Selecionar Empresa</label>
                            <input type="radio" name="ali-empresa-selecionada" id="ali-empresa3-selecionada" value="3" onchange="mostrarJustificativa('ali', 3)">
                        </div>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="ali-menor-valor">Menor Valor Cotado (R$)</label>
                    <input type="text" id="ali-menor-valor" readonly>
                </div>
                <div class="form-group" id="ali-justificativa-container" style="display: none;">
                    <label for="ali-justificativa">Justificativa</label>
                    <textarea id="ali-justificativa" placeholder="Justifique a escolha de uma empresa com valor superior ao menor cotado"></textarea>
                </div>
                <button class="btn btn-success" id="ali-adicionar-carrinho">Adicionar ao Carrinho</button>
            </div>
        </div>

        <!-- Carrinho -->
        <div class="carrinho">
            <h3>Carrinho de Compras</h3>
            <div id="lista-carrinho" class="carrinho-vazio">
                Nenhum item adicionado ao carrinho
            </div>
            <div id="total-carrinho" class="total-carrinho">
                Total no Carrinho: R$ 0,00
            </div>
            <div class="declaracao-container">
                <label>
                    <input type="checkbox" id="declaracao-checkbox">
                    Declaro que os custos aqui registrados estão em estrita conformidade aos orçamentos apresentados para fins de comprovação dos valores estimados de cada item.
                </label>
            </div>
            <div class="acoes-carrinho">
                <button class="btn" id="btn-exportar-excel" disabled>Gerar Excel</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        © 2025 Ministério do Esporte - Todos os direitos reservados
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
    if (typeof XLSX === 'undefined') {
        alert('Erro: A biblioteca SheetJS não foi carregada.');
        return;
    }

    // Cache para armazenar dados das empresas entre adições
    let empresasCache = {
        srv: [{}, {}, {}],
        me: [{}, {}, {}],
        uni: [{}, {}, {}],
        idv: [{}, {}, {}],
        ali: [{}, {}, {}]
    };

    let dadosPlanilha = {
        material: [],
        servicos: [],
        locacao: [],
        uniforme: [],
        impressos: [],
        alimentacao: []
    };

    const categoriasMap = {
        'Material': 'material',
        'Serviços': 'servicos',
        'Locação': 'locacao',
        'Uniforme': 'uniforme',
        'Impressos': 'impressos',
        'Alimentação': 'alimentacao'
    };

    const itensAlimentacao = [
        'ÁGUA',
        'ÁGUA MINERAL',
        'ALIMENTAÇÃO - ALMOÇO/JANTA (MARMITEX)',
        'ALIMENTAÇÃO - KIT LANCHE'
    ];

    async function carregarPlanilha() {
        try {
            const response = await fetch('data/Base_Dados.xlsx');
            if (!response.ok) {
                console.warn(`Erro ao carregar Base_Dados.xlsx: ${response.statusText}. Usando dados mock.`);
                inicializarDadosMock();
                return;
            }
            const data = await response.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            Object.keys(categoriasMap).forEach(aba => {
                const sheet = workbook.Sheets[aba];
                if (!sheet) return;
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: ['ITEM', 'SUBITEM'] }).slice(1);
                const categoria = categoriasMap[aba];
                jsonData.forEach(row => {
                    if (!row.ITEM || !row.SUBITEM) return;
                    if ((aba === 'Material' || aba === 'Locação') && itensAlimentacao.includes(row.ITEM.toUpperCase())) {
                        dadosPlanilha.alimentacao.push(row);
                    } else {
                        dadosPlanilha[categoria].push(row);
                    }
                });
                dadosPlanilha[categoria].push({ ITEM: 'Outros', SUBITEM: 'Especifique' });
            });
            inicializarSelects();
        } catch (error) {
            console.error('Erro ao carregar a planilha:', error);
            inicializarDadosMock();
        }
    }

    function inicializarDadosMock() {
        dadosPlanilha.servicos = [
            { ITEM: 'Coordenador de eventos', SUBITEM: 'Gestão' },
            { ITEM: 'Professor', SUBITEM: 'Aulas práticas' },
            { ITEM: 'Professor de Educação Física', SUBITEM: 'Aulas de educação física' },
            { ITEM: 'Outros', SUBITEM: 'Especifique' }
        ];
        dadosPlanilha.material = [
            { ITEM: 'Bola de futebol', SUBITEM: 'Tamanho 5' },
            { ITEM: 'Rede', SUBITEM: 'Volei' },
            { ITEM: 'Outros', SUBITEM: 'Especifique' }
        ];
        dadosPlanilha.uniforme = [
            { ITEM: 'Camiseta', SUBITEM: 'Adulto' },
            { ITEM: 'Calção', SUBITEM: 'Juvenil' },
            { ITEM: 'Outros', SUBITEM: 'Especifique' }
        ];
        dadosPlanilha.impressos = [
            { ITEM: 'Banner', SUBITEM: '1x2m' },
            { ITEM: 'Flyer', SUBITEM: 'A5' },
            { ITEM: 'Outros', SUBITEM: 'Especifique' }
        ];
        dadosPlanilha.alimentacao = [
            { ITEM: 'Água', SUBITEM: '500ml' },
            { ITEM: 'Kit Lanche', SUBITEM: 'Pão e suco' },
            { ITEM: 'Outros', SUBITEM: 'Especifique' }
        ];
        inicializarSelects();
    }

    function inicializarSelects() {
        const cargoSelect = document.getElementById('srv-cargo');
        const dados = dadosPlanilha.servicos;
        const itensUnicos = [...new Set(dados.map(row => row.ITEM))];
        cargoSelect.innerHTML = '<option value="">Selecione um cargo</option>' +
            itensUnicos.map(item => `<option value="${item}">${item}</option>`).join('');
    }

    const prefixoToCategoria = {
        'srv': 'servicos',
        'me': 'material',
        'uni': 'uniforme',
        'idv': 'impressos',
        'ali': 'alimentacao'
    };

    window.filtrarItens = function(prefixo) {
        const input = document.getElementById(`${prefixo}-item`);
        const suggestions = document.getElementById(`${prefixo}-item-suggestions`);
        const categoria = prefixoToCategoria[prefixo];
        const dados = dadosPlanilha[categoria];
        const query = input.value.toLowerCase();
        if (query.length < 1) {
            suggestions.style.display = 'none';
            return;
        }
        const itensUnicos = [...new Set(dados.map(row => row.ITEM))].filter(item =>
            item && item.toLowerCase().includes(query)
        );
        suggestions.innerHTML = itensUnicos.map(item =>
            `<div class="suggestion-item" onclick="selecionarItem('${prefixo}', '${item.replace(/'/g, "\\'")}')">${item}</div>`
        ).join('');
        suggestions.style.display = itensUnicos.length ? 'block' : 'none';
    };

    window.selecionarItem = function(prefixo, item) {
        const input = document.getElementById(`${prefixo}-item`);
        const suggestions = document.getElementById(`${prefixo}-item-suggestions`);
        const subitemInput = document.getElementById(`${prefixo}-subitem`);
        const outrosContainer = document.getElementById(`${prefixo}-outros-container`);
        input.value = item;
        subitemInput.value = '';
        suggestions.style.display = 'none';
        outrosContainer.style.display = item === 'Outros' ? 'block' : 'none';
        filtrarSubitens(prefixo);
        subitemInput.focus();
    };

    window.filtrarSubitens = function(prefixo) {
        const itemInput = document.getElementById(`${prefixo}-item`).value;
        const subitemInput = document.getElementById(`${prefixo}-subitem`);
        const suggestions = document.getElementById(`${prefixo}-subitem-suggestions`);
        const categoria = prefixoToCategoria[prefixo];
        const dados = dadosPlanilha[categoria];
        const query = subitemInput.value.toLowerCase();
        if (!itemInput) {
            suggestions.style.display = 'none';
            return;
        }
        const subitens = dados.filter(row =>
            row.ITEM === itemInput && row.SUBITEM && row.SUBITEM.toLowerCase().includes(query)
        );
        suggestions.innerHTML = subitens.map(row =>
            `<div class="suggestion-item" onclick="selecionarSubitem('${prefixo}', '${row.SUBITEM.replace(/'/g, "\\'")}')">${row.SUBITEM}</div>`
        ).join('');
        suggestions.style.display = subitens.length ? 'block' : 'none';
    };

    window.selecionarSubitem = function(prefixo, subitem) {
        const subitemInput = document.getElementById(`${prefixo}-subitem`);
        const suggestions = document.getElementById(`${prefixo}-subitem-suggestions`);
        subitemInput.value = subitem;
        suggestions.style.display = 'none';
    };

    window.toggleOutrosField = function(prefixo) {
        const cargoSelect = document.getElementById(`${prefixo}-cargo`);
        const outrosContainer = document.getElementById(`${prefixo}-outros-container`);
        outrosContainer.style.display = cargoSelect.value === 'Outros' ? 'block' : 'none';
    };

    window.toggleLocacaoFields = function() {
        const tipo = document.getElementById('me-tipo').value;
        const periodoContainer = document.getElementById('me-periodo-container');
        const periodoValorContainer = document.getElementById('me-periodo-valor-container');
        if (tipo === 'aquisicao') {
            periodoContainer.style.display = 'none';
            periodoValorContainer.style.display = 'none';
            document.getElementById('me-periodo').value = 'diarias';
            document.getElementById('me-periodo-valor').value = '1';
        } else {
            periodoContainer.style.display = 'block';
            periodoValorContainer.style.display = 'block';
        }
        calcularTotal('me');
    };

    window.mostrarJustificativa = function(prefixo, empresaIndex) {
        const menorValor = parseFloat(document.getElementById(`${prefixo}-menor-valor`).value.replace('R$ ', '').replace(/\./g, '').replace(',', '.')) || 0;
        const valorSelecionado = parseFloat(document.getElementById(`${prefixo}-empresa${empresaIndex}-total`).value.replace('R$ ', '').replace(/\./g, '').replace(',', '.')) || 0;
        const justificativaContainer = document.getElementById(`${prefixo}-justificativa-container`);
        justificativaContainer.style.display = valorSelecionado > menorValor ? 'block' : 'none';
    };

    let numeroProposta = sessionStorage.getItem('numeroProposta') || 'sem-numero';
    const cnpj = sessionStorage.getItem('cnpj') || '';
    const nomeEntidade = sessionStorage.getItem('nomeEntidade') || '';
    const valorEmenda = parseFloat(sessionStorage.getItem('valorEmenda')) || 1000000;

    numeroProposta = numeroProposta.replace(/[^a-zA-Z0-9_-]/g, '_');
    document.getElementById('valor-total').textContent = formatarMoeda(valorEmenda);
    document.getElementById('valor-restante').textContent = formatarMoeda(valorEmenda);

    let carrinho = [];
    let valorGasto = 0;
    let itemIdCounter = 1;

    const declaracaoCheckbox = document.getElementById('declaracao-checkbox');
    const btnExportarExcel = document.getElementById('btn-exportar-excel');

    function formatarMoeda(valor) {
        const numericValor = parseFloat(valor) || 0;
        return `R$ ${numericValor.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        })}`;
    }

    function formatarCNPJ(cnpj) {
        cnpj = cnpj.replace(/\D/g, '');
        if (cnpj.length <= 14) {
            if (cnpj.length > 2) cnpj = cnpj.substring(0, 2) + '.' + cnpj.substring(2);
            if (cnpj.length > 6) cnpj = cnpj.substring(0, 6) + '.' + cnpj.substring(6);
            if (cnpj.length > 10) cnpj = cnpj.substring(0, 10) + '/' + cnpj.substring(10);
            if (cnpj.length > 15) cnpj = cnpj.substring(0, 15) + '-' + cnpj.substring(15);
            return cnpj.substring(0, 18);
        }
        return cnpj;
    }

    function parseValorMonetario(inputValue) {
        if (!inputValue) return 0;
        // Remove tudo exceto números, pontos e vírgula
        let value = inputValue.replace(/[^\d,.]/g, '');
        // Remove pontos de milhares e substitui vírgula por ponto
        const cleanedValue = value
            .replace(/\.(?=.*\.)|,/g, (m) => m === ',' ? '.' : '')
            .replace(/^0+(?=\d)/, ''); // Remove zeros à esquerda
        return parseFloat(cleanedValue) || 0;
    }

    function calcularTotal(prefixo) {
        const quantidadeInput = document.getElementById(`${prefixo}-quantidade`);
        const periodoValorInput = document.getElementById(`${prefixo}-periodo-valor`);
        const totalInput = document.getElementById(`${prefixo}-total`);
        const quantidade = parseInt(quantidadeInput.value) || 0;
        let total = quantidade;
        if (prefixo === 'me' && document.getElementById('me-tipo').value === 'locacao') {
            const periodoValor = parseInt(periodoValorInput.value) || 0;
            total = quantidade * periodoValor;
        } else if (prefixo !== 'me') {
            const periodoValor = parseInt(periodoValorInput.value) || 0;
            total = quantidade * periodoValor;
        }
        totalInput.value = total;
        calcularTotaisEmpresas(prefixo);
        return total;
    }

    function calcularTotaisEmpresas(prefixo) {
        const total = parseInt(document.getElementById(`${prefixo}-total`).value) || 0;
        let menorValor = Infinity;
        for (let i = 1; i <= 3; i++) {
            const unitarioInput = document.getElementById(`${prefixo}-empresa${i}-unitario`);
            if (!unitarioInput) continue;
            const unitario = parseFloat(unitarioInput.getAttribute('data-value') || '0') || 0;
            const valorTotal = unitario * total;
            const valorTotalFormatado = formatarMoeda(valorTotal);
            const totalInput = document.getElementById(`${prefixo}-empresa${i}-total`);
            if (totalInput) {
                totalInput.value = valorTotalFormatado;
            }
            if (valorTotal < menorValor && valorTotal > 0) {
                menorValor = valorTotal;
            }
        }
        const menorValorInput = document.getElementById(`${prefixo}-menor-valor`);
        if (menorValorInput) {
            menorValorInput.value = menorValor !== Infinity ? formatarMoeda(menorValor) : 'R$ 0,00';
        }
        return menorValor !== Infinity ? menorValor : 0;
    }

    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            const tabId = this.getAttribute('data-tab');
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        });
    });

    const prefixes = ['srv', 'me', 'uni', 'idv', 'ali'];
    prefixes.forEach(prefixo => {
        const quantidadeInput = document.getElementById(`${prefixo}-quantidade`);
        const periodoValorInput = document.getElementById(`${prefixo}-periodo-valor`);
        if (quantidadeInput) {
            quantidadeInput.addEventListener('input', () => calcularTotal(prefixo));
        }
        if (periodoValorInput) {
            periodoValorInput.addEventListener('input', () => calcularTotal(prefixo));
        }
        if (prefixo === 'me') {
            const tipoSelect = document.getElementById('me-tipo');
            if (tipoSelect) {
                tipoSelect.addEventListener('change', () => calcularTotal(prefixo));
            }
        }
        for (let i = 1; i <= 3; i++) {
            const cnpjInput = document.getElementById(`${prefixo}-empresa${i}-cnpj`);
            if (cnpjInput) {
                cnpjInput.addEventListener('input', function(e) {
                    e.target.value = formatarCNPJ(e.target.value);
                });
            }
        }
    });

    // Nova lógica para campos monetários
    document.querySelectorAll('.valor-monetario').forEach(input => {
    input.addEventListener('input', function(e) {
        // Captura a posição atual do cursor
        let cursorPosition = e.target.selectionStart;
        let value = e.target.value;

        // Remove caracteres não permitidos (mantém números, vírgula e ponto)
        value = value.replace(/[^0-9,.]/g, '');

        // Impede múltiplos pontos ou vírgulas
        const parts = value.split(/[,.]/);
        if (parts.length > 2) {
            value = parts[0] + ',' + parts[1];
        }

        // Atualiza o valor no campo
        e.target.value = value;

        // Converte para valor numérico
        let numericValue = parseFloat(value.replace(',', '.')) || 0;
        if (parts.length > 1) {
            // Ajusta para manter até 2 casas decimais
            const decimals = parts[1].slice(0, 2);
            numericValue = parseFloat(`${parts[0]}.${decimals}`) || 0;
        }

        // Armazena o valor numérico puro
        e.target.setAttribute('data-value', numericValue.toString());

        // Restaura a posição do cursor
        e.target.selectionStart = e.target.selectionEnd = cursorPosition;

        // Atualiza totais da empresa se necessário
        const id = e.target.id;
        if (id.includes('unitario')) {
            const prefixo = id.split('-')[0];
            calcularTotaisEmpresas(prefixo);
        }
    });

    // Formata o valor ao sair do campo
    input.addEventListener('blur', function(e) {
        let numericValue = parseFloat(e.target.getAttribute('data-value') || '0') || 0;
        // Formata como moeda brasileira
        e.target.value = numericValue.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    });

    // Permite apenas números, vírgula, ponto e teclas de controle
    input.addEventListener('keydown', function(e) {
        // Permite teclas de controle
        if (['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'].includes(e.key)) {
            return;
        }
        // Permite números, vírgula e ponto
        if (!/[\d,.]/.test(e.key) && e.key.length === 1) {
            e.preventDefault();
        }
    });
});

    prefixes.forEach(prefixo => {
        const btnAdicionar = document.getElementById(`${prefixo}-adicionar-carrinho`);
        if (!btnAdicionar) return;
        btnAdicionar.addEventListener('click', function() {
            const cargoOuItem = prefixo === 'srv'
                ? (document.getElementById(`${prefixo}-cargo`).value === 'Outros'
                    ? document.getElementById(`${prefixo}-outros`).value.trim()
                    : document.getElementById(`${prefixo}-cargo`).value.trim())
                : document.getElementById(`${prefixo}-item`).value.trim();
            const subitem = prefixo !== 'srv'
                ? (document.getElementById(`${prefixo}-item`).value === 'Outros'
                    ? document.getElementById(`${prefixo}-outros`).value.trim()
                    : document.getElementById(`${prefixo}-subitem`).value.trim())
                : null;
            const descricao = document.getElementById(`${prefixo}-descricao`).value.trim();
            const quantidade = parseInt(document.getElementById(`${prefixo}-quantidade`).value) || 0;
            const periodo = prefixo === 'me' && document.getElementById('me-tipo').value === 'aquisicao'
                ? 'aquisicao'
                : document.getElementById(`${prefixo}-periodo`)?.value || 'diarias';
            const periodoValor = prefixo === 'me' && document.getElementById('me-tipo').value === 'aquisicao'
                ? 1
                : parseInt(document.getElementById(`${prefixo}-periodo-valor`)?.value) || 0;
            const tipo = prefixo === 'me' ? document.getElementById('me-tipo').value : null;
            const total = tipo === 'aquisicao' ? quantidade : quantidade * periodoValor;

            if (!cargoOuItem || !descricao || quantidade <= 0 || (tipo !== 'aquisicao' && periodoValor <= 0)) {
                alert('Preencha todos os campos obrigatórios (item/cargo, descrição, quantidade, período)!');
                return;
            }

            if (prefixo !== 'srv' && !subitem && !descricao) {
                alert('Preencha pelo menos o subitem ou a descrição do item!');
                return;
            }

            const empresas = [];
            let menorValor = Infinity;
            let empresaSelecionada = null;
            const selecionada = document.querySelector(`input[name="${prefixo}-empresa-selecionada"]:checked`);

            for (let i = 1; i <= 3; i++) {
                const nome = document.getElementById(`${prefixo}-empresa${i}-nome`).value.trim();
                const cnpj = document.getElementById(`${prefixo}-empresa${i}-cnpj`).value.trim();
                const link = document.getElementById(`${prefixo}-empresa${i}-link`).value.trim();
                const unitarioInput = document.getElementById(`${prefixo}-empresa${i}-unitario`);
                const unitario = parseFloat(unitarioInput.getAttribute('data-value') || '0') || 0;
                const valorTotal = unitario * total;

                empresasCache[prefixo][i-1] = { nome, cnpj, link };

                if (nome && cnpj && unitario > 0) {
                    if (!validarCNPJ(cnpj)) {
                        alert(`CNPJ inválido para Empresa ${i} na seção ${prefixo.toUpperCase()}.`);
                        return;
                    }
                    empresas.push({
                        nome,
                        cnpj,
                        link: link || '',
                        unitario,
                        total: valorTotal
                    });

                    if (valorTotal < menorValor && valorTotal > 0) {
                        menorValor = valorTotal;
                    }

                    if (selecionada && parseInt(selecionada.value) === i) {
                        empresaSelecionada = {
                            nome,
                            cnpj,
                            link: link || '',
                            unitario,
                            total: valorTotal
                        };
                    }
                } else {
                    empresas.push({ nome: '', cnpj: '', link: '', unitario: 0, total: 0 });
                }
            }

            if (empresas.filter(e => e.nome && e.cnpj && e.unitario > 0).length < 1) {
                alert('Preencha pelo menos uma empresa com nome, CNPJ e valor unitário válidos!');
                return;
            }

            if (!empresaSelecionada) {
                alert('Selecione uma empresa antes de adicionar ao carrinho!');
                return;
            }

            const justificativa = empresaSelecionada.total > menorValor && menorValor !== Infinity
                ? document.getElementById(`${prefixo}-justificativa`).value.trim()
                : '';

            if (empresaSelecionada.total > menorValor && menorValor !== Infinity && !justificativa) {
                alert('Por favor, forneça uma justificativa para a escolha de uma empresa com valor superior ao menor cotado.');
                return;
            }

            const itemCarrinho = {
                id: itemIdCounter++,
                categoria: prefixoToCategoria[prefixo],
                item: cargoOuItem,
                subitem: subitem || '',
                descricao,
                quantidade,
                periodo: tipo === 'aquisicao' ? 'N/A' : periodo,
                periodoValor: tipo === 'aquisicao' ? 1 : periodoValor,
                tipo: tipo || 'N/A',
                total,
                empresas,
                empresaSelecionada,
                justificativa,
                dataAdicao: new Date().toISOString()
            };

            carrinho.push(itemCarrinho);
            valorGasto += empresaSelecionada.total;
            atualizarCarrinho();
            limparFormulario(prefixo);
        });
    });

    function validarCNPJ(cnpj) {
        cnpj = cnpj.replace(/[^\d]+/g, '');
        if (cnpj === '') return false;
        if (cnpj.length !== 14) return false;

        if (cnpj === "00000000000000" ||
            cnpj === "11111111111111" ||
            cnpj === "22222222222222" ||
            cnpj === "33333333333333" ||
            cnpj === "44444444444444" ||
            cnpj === "55555555555555" ||
            cnpj === "66666666666666" ||
            cnpj === "77777777777777" ||
            cnpj === "88888888888888" ||
            cnpj === "99999999999999")
            return false;

        let tamanho = cnpj.length - 2;
        let numeros = cnpj.substring(0, tamanho);
        let digitos = cnpj.substring(tamanho);
        let soma = 0;
        let pos = tamanho - 7;

        for (let i = tamanho; i >= 1; i--) {
            soma += numeros.charAt(tamanho - i) * pos--;
            if (pos < 2) pos = 9;
        }

        let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
        if (resultado != digitos.charAt(0)) return false;

        tamanho = tamanho + 1;
        numeros = cnpj.substring(0, tamanho);
        soma = 0;
        pos = tamanho - 7;

        for (let i = tamanho; i >= 1; i--) {
            soma += numeros.charAt(tamanho - i) * pos--;
            if (pos < 2) pos = 9;
        }

        resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
        if (resultado != digitos.charAt(1)) return false;

        return true;
    }

    function atualizarCarrinho() {
        const listaCarrinho = document.getElementById('lista-carrinho');
        const totalCarrinho = document.getElementById('total-carrinho');
        const valorRestante = valorEmenda - valorGasto;

        if (carrinho.length === 0) {
            listaCarrinho.innerHTML = '<div class="carrinho-vazio">Nenhum item adicionado ao carrinho</div>';
            totalCarrinho.textContent = 'Total no Carrinho: R$ 0,00';
        } else {
            listaCarrinho.innerHTML = carrinho.map(item => `
                <div class="item-carrinho" data-id="${item.id}">
                    <div class="item-carrinho-info">
                        <strong>${item.item}${item.subitem ? ' - ' + item.subitem : ''}</strong><br>
                        ${item.descricao}<br>
                        Quantidade: ${item.quantidade} | 
                        ${item.tipo === 'aquisicao' ? 'Aquisição' : `${item.periodoValor} ${item.periodo === 'diarias' ? 'dia(s)' : 'mês(es)'}`}<br>
                        Empresa selecionada: ${item.empresaSelecionada.nome} (${formatarMoeda(item.empresaSelecionada.total)})
                    </div>
                    <div class="item-carrinho-acoes">
                        <button onclick="editarItemCarrinho(${item.id})"><i class="fas fa-edit"></i> Editar</button>
                        <button onclick="removerItemCarrinho(${item.id})"><i class="fas fa-trash"></i> Remover</button>
                    </div>
                </div>
            `).join('');

            totalCarrinho.textContent = `Total no Carrinho: ${formatarMoeda(valorGasto)}`;
        }

        document.getElementById('valor-gasto').textContent = formatarMoeda(valorGasto);
        document.getElementById('valor-restante').textContent = formatarMoeda(valorRestante);

        btnExportarExcel.disabled = carrinho.length === 0 || !declaracaoCheckbox.checked;
    }

    window.removerItemCarrinho = function(id) {
        const itemIndex = carrinho.findIndex(item => item.id === id);
        if (itemIndex !== -1) {
            valorGasto -= carrinho[itemIndex].empresaSelecionada.total;
            carrinho.splice(itemIndex, 1);
            atualizarCarrinho();
        }
    };

    window.editarItemCarrinho = function(id) {
        const item = carrinho.find(item => item.id === id);
        if (!item) return;

        const prefixoMap = {
            'servicos': 'srv',
            'material': 'me',
            'uniforme': 'uni',
            'impressos': 'idv',
            'alimentacao': 'ali'
        };
        const prefixo = prefixoMap[item.categoria];

        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.tab[data-tab="${item.categoria === 'servicos' ? 'servicos' : item.categoria}"]`).classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(item.categoria === 'servicos' ? 'servicos' : item.categoria).classList.add('active');

        if (prefixo === 'srv') {
            if (item.item === 'Outros') {
                document.getElementById(`${prefixo}-cargo`).value = 'Outros';
                document.getElementById(`${prefixo}-outros`).value = item.item;
                document.getElementById(`${prefixo}-outros-container`).style.display = 'block';
            } else {
                document.getElementById(`${prefixo}-cargo`).value = item.item;
                document.getElementById(`${prefixo}-outros`).value = '';
                document.getElementById(`${prefixo}-outros-container`).style.display = 'none';
            }
        } else {
            document.getElementById(`${prefixo}-item`).value = item.item;
            document.getElementById(`${prefixo}-subitem`).value = item.subitem;
            document.getElementById(`${prefixo}-outros`).value = item.item === 'Outros' ? item.subitem : '';
            document.getElementById(`${prefixo}-outros-container`).style.display = item.item === 'Outros' ? 'block' : 'none';
        }

        document.getElementById(`${prefixo}-descricao`).value = item.descricao;
        document.getElementById(`${prefixo}-quantidade`).value = item.quantidade;
        if (prefixo === 'me') {
            document.getElementById(`${prefixo}-tipo`).value = item.tipo;
            toggleLocacaoFields();
        }
        if (item.periodo !== 'N/A') {
            document.getElementById(`${prefixo}-periodo`).value = item.periodo;
            document.getElementById(`${prefixo}-periodo-valor`).value = item.periodoValor;
        }

        for (let i = 0; i < 3; i++) {
            const empresa = item.empresas[i] || {};
            document.getElementById(`${prefixo}-empresa${i+1}-nome`).value = empresa.nome || '';
            document.getElementById(`${prefixo}-empresa${i+1}-cnpj`).value = empresa.cnpj || '';
            document.getElementById(`${prefixo}-empresa${i+1}-link`).value = empresa.link || '';
            const unitarioInput = document.getElementById(`${prefixo}-empresa${i+1}-unitario`);
            const unitarioValue = empresa.unitario || 0;
            unitarioInput.value = unitarioValue ? unitarioValue.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) : '0,00';
            unitarioInput.setAttribute('data-value', unitarioValue.toString());
            document.getElementById(`${prefixo}-empresa${i+1}-total`).value = empresa.total ? formatarMoeda(empresa.total) : 'R$ 0,00';
            document.getElementById(`${prefixo}-empresa${i+1}-selecionada`).checked = item.empresaSelecionada && item.empresaSelecionada.nome === empresa.nome;
        }

        document.getElementById(`${prefixo}-justificativa`).value = item.justificativa || '';
        document.getElementById(`${prefixo}-justificativa-container`).style.display = item.justificativa ? 'block' : 'none';
        calcularTotaisEmpresas(prefixo);

        valorGasto -= item.empresaSelecionada.total;
        carrinho = carrinho.filter(i => i.id !== id);
        atualizarCarrinho();
    };

    function limparFormulario(prefixo) {
        if (prefixo === 'srv') {
            document.getElementById(`${prefixo}-cargo`).value = '';
            document.getElementById(`${prefixo}-outros`).value = '';
            document.getElementById(`${prefixo}-outros-container`).style.display = 'none';
        } else {
            document.getElementById(`${prefixo}-item`).value = '';
            document.getElementById(`${prefixo}-subitem`).value = '';
            document.getElementById(`${prefixo}-outros`).value = '';
            document.getElementById(`${prefixo}-outros-container`).style.display = 'none';
        }

        document.getElementById(`${prefixo}-descricao`).value = '';
        document.getElementById(`${prefixo}-quantidade`).value = '1';
        document.getElementById(`${prefixo}-periodo`).value = 'diarias';
        document.getElementById(`${prefixo}-periodo-valor`).value = '1';
        document.getElementById(`${prefixo}-total`).value = '';
        document.getElementById(`${prefixo}-justificativa`).value = '';
        document.getElementById(`${prefixo}-justificativa-container`).style.display = 'none';
        document.getElementById(`${prefixo}-menor-valor`).value = '';

        for (let i = 1; i <= 3; i++) {
            const empresa = empresasCache[prefixo][i-1] || {};
            document.getElementById(`${prefixo}-empresa${i}-nome`).value = empresa.nome || '';
            document.getElementById(`${prefixo}-empresa${i}-cnpj`).value = empresa.cnpj || '';
            document.getElementById(`${prefixo}-empresa${i}-link`).value = empresa.link || '';
            const unitarioInput = document.getElementById(`${prefixo}-empresa${i}-unitario`);
            unitarioInput.value = '0,00';
            unitarioInput.setAttribute('data-value', '0');
            document.getElementById(`${prefixo}-empresa${i}-total`).value = 'R$ 0,00';
            document.getElementById(`${prefixo}-empresa${i}-selecionada`).checked = false;
        }
    }

    declaracaoCheckbox.addEventListener('change', function() {
        btnExportarExcel.disabled = carrinho.length === 0 || !this.checked;
    });

    btnExportarExcel.addEventListener('click', function() {
        if (carrinho.length === 0) {
            alert('O carrinho está vazio. Adicione itens antes de exportar.');
            return;
        }

        if (!declaracaoCheckbox.checked) {
            alert('Você precisa marcar a declaração antes de exportar.');
            return;
        }

        gerarExcel();
    });

    async function gerarExcel() {
        try {
            // Validate prerequisites
            console.log('Iniciando geração de Excel. Estado do carrinho:', {
                carrinhoLength: carrinho.length,
                declaracaoChecked: declaracaoCheckbox.checked,
                numeroProposta,
                nomeEntidade,
                cnpj
            });

            if (carrinho.length === 0) {
                alert('O carrinho está vazio. Adicione itens antes de exportar.');
                return;
            }

            if (!declaracaoCheckbox.checked) {
                alert('Você precisa marcar a declaração antes de exportar.');
                return;
            }

            if (!numeroProposta || !nomeEntidade || !cnpj) {
                alert('Preencha todos os campos obrigatórios: Número da Proposta, Entidade e CNPJ.');
                return;
            }

            // Initialize Excel workbook
            const workbook = new ExcelJS.Workbook();
            workbook.creator = 'Ministério do Esporte';
            workbook.lastModifiedBy = 'Sistema de Precificação';
            workbook.created = new Date();
            workbook.modified = new Date();

            const worksheet = workbook.addWorksheet('Orçamento');

            // Protect worksheet
            await worksheet.protect('Mesp@123456', {
                selectLockedCells: true,
                selectUnlockedCells: true,
                formatCells: false,
                formatColumns: false,
                formatRows: false,
                insertColumns: false,
                insertRows: false,
                insertHyperlinks: false,
                deleteColumns: false,
                deleteRows: false,
                sort: false,
                autoFilter: false,
                pivotTables: false
            });

            // Add metadata
            worksheet.getCell('A2').value = 'PROPOSTA';
            worksheet.getCell('B2').value = numeroProposta;
            worksheet.getCell('A3').value = 'CNPJ';
            worksheet.getCell('B3').value = cnpj;
            worksheet.getCell('A4').value = 'ENTIDADE';
            worksheet.getCell('B4').value = nomeEntidade;
            worksheet.getCell('A5').value = 'DATA';
            worksheet.getCell('B5').value = new Date().toLocaleDateString('pt-BR');

            // Sub-header row
            const subHeaderRow = worksheet.getRow(7);
            subHeaderRow.getCell(5).value = 'MEDIDAS';
            subHeaderRow.getCell(8).value = '1ª COTAÇÃO';
            subHeaderRow.getCell(12).value = '2ª COTAÇÃO';
            subHeaderRow.getCell(16).value = '3ª COTAÇÃO';
            subHeaderRow.getCell(20).value = 'COTAÇÃO DEFINIDA';

            // Header row
            const headerRow = worksheet.getRow(8);
            headerRow.getCell(1).value = 'Nº';
            headerRow.getCell(2).value = 'TIPO';
            headerRow.getCell(3).value = 'ITEM';
            headerRow.getCell(4).value = 'ESPECIFICAÇÃO DO ITEM';
            headerRow.getCell(5).value = 'QTD';
            headerRow.getCell(6).value = 'DIÁRIAS/MESES';
            headerRow.getCell(7).value = 'TOTAL';
            headerRow.getCell(8).value = 'RAZÃO ou LINK';
            headerRow.getCell(9).value = 'CNPJ';
            headerRow.getCell(10).value = 'VALOR UNITÁRIO';
            headerRow.getCell(11).value = 'VALOR TOTAL';
            headerRow.getCell(12).value = 'RAZÃO ou LINK';
            headerRow.getCell(13).value = 'CNPJ';
            headerRow.getCell(14).value = 'VALOR UNITÁRIO';
            headerRow.getCell(15).value = 'VALOR TOTAL';
            headerRow.getCell(16).value = 'RAZÃO ou LINK';
            headerRow.getCell(17).value = 'CNPJ';
            headerRow.getCell(18).value = 'VALOR UNITÁRIO';
            headerRow.getCell(19).value = 'VALOR TOTAL';
            headerRow.getCell(20).value = 'VALOR UNITÁRIO';
            headerRow.getCell(21).value = 'VALOR TOTAL';
            headerRow.getCell(22).value = 'JUSTIFICATIVA';
            headerRow.getCell(23).value = 'MENOR VALOR DE COTAÇÃO';

            // Merge cells for sub-headers
            worksheet.mergeCells('E7:G7');
            worksheet.mergeCells('H7:K7');
            worksheet.mergeCells('L7:O7');
            worksheet.mergeCells('P7:S7');
            worksheet.mergeCells('T7:U7');

            // Style headers
            headerRow.eachCell({ includeEmpty: false }, (cell) => {
                cell.font = { bold: true, color: { argb: 'FF000000' } };
                cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
            });

            subHeaderRow.eachCell({ includeEmpty: false }, (cell) => {
                cell.font = { bold: true, color: { argb: 'FF000000' } };
                cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
            });

            // Set column widths
            worksheet.columns = [
                { width: 5 }, { width: 15 }, { width: 20 }, { width: 30 }, { width: 10 },
                { width: 15 }, { width: 10 }, { width: 20 }, { width: 15 }, { width: 15 },
                { width: 15 }, { width: 20 }, { width: 15 }, { width: 15 }, { width: 15 },
                { width: 20 }, { width: 15 }, { width: 15 }, { width: 15 }, { width: 15 },
                { width: 15 }, { width: 30 }, { width: 15 }
            ];

            // Apply fill colors to sub-headers
            subHeaderRow.getCell(5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFB266' } };
            subHeaderRow.getCell(8).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFCC99' } };
            subHeaderRow.getCell(12).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'CCCCFF' } };
            subHeaderRow.getCell(16).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '99CCFF' } };
            subHeaderRow.getCell(20).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF9999' } };

            // Add carrinho data
            let rowIndex = 9;
            carrinho.forEach(item => {
                const totals = [
                    item.empresas[0]?.total || 0,
                    item.empresas[1]?.total || 0,
                    item.empresas[2]?.total || 0
                ].filter(t => t > 0 && !isNaN(t));
                const menorValor = totals.length > 0 ? Math.min(...totals) : 0;
                const justificativa = item.empresaSelecionada.total > menorValor && menorValor !== 0 ? item.justificativa : '';
                const menorValorCotado = menorValor !== 0 ? menorValor : 0;
                const tipo = item.categoria.toUpperCase() === 'SERVICOS' ? 'SERVIÇOS/RECURSOS HUMANOS' : item.categoria.toUpperCase();
                const row = worksheet.getRow(rowIndex);
                row.values = [
                    item.id, tipo, `${item.item}${item.subitem ? ' - ' + item.subitem : ''}`, item.descricao,
                    item.quantidade, item.periodo === 'N/A' ? 'N/A' : (item.periodo === 'diarias' ? 'Diárias' : 'Meses'), item.total,
                    item.empresas[0]?.nome && item.empresas[0]?.link ? `${item.empresas[0].nome} - ${item.empresas[0].link}` : item.empresas[0]?.nome || '',
                    item.empresas[0]?.cnpj || '', item.empresas[0]?.unitario || 0, item.empresas[0]?.total || 0,
                    item.empresas[1]?.nome && item.empresas[1]?.link ? `${item.empresas[1].nome} - ${item.empresas[1].link}` : item.empresas[1]?.nome || '',
                    item.empresas[1]?.cnpj || '', item.empresas[1]?.unitario || 0, item.empresas[1]?.total || 0,
                    item.empresas[2]?.nome && item.empresas[2]?.link ? `${item.empresas[2].nome} - ${item.empresas[2].link}` : item.empresas[2]?.nome || '',
                    item.empresas[2]?.cnpj || '', item.empresas[2]?.unitario || 0, item.empresas[2]?.total || 0,
                    item.empresaSelecionada.unitario, item.empresaSelecionada.total,
                    justificativa,
                    menorValorCotado
                ];
                row.getCell(3).alignment = { wrapText: true };
                row.getCell(4).alignment = { wrapText: true };
                row.getCell(9).alignment = { wrapText: true };
                row.getCell(13).alignment = { wrapText: true };
                row.getCell(17).alignment = { wrapText: true };
                row.getCell(10).numFmt = '"R$ "#,##0.00';
                row.getCell(11).numFmt = '"R$ "#,##0.00';
                row.getCell(14).numFmt = '"R$ "#,##0.00';
                row.getCell(15).numFmt = '"R$ "#,##0.00';
                row.getCell(18).numFmt = '"R$ "#,##0.00';
                row.getCell(19).numFmt = '"R$ "#,##0.00';
                row.getCell(20).numFmt = '"R$ "#,##0.00';
                row.getCell(21).numFmt = '"R$ "#,##0.00';
                row.getCell(23).numFmt = '"R$ "#,##0.00';
                row.height = 60;
                rowIndex++;
            });

            // Add total row
            const totalRow = worksheet.getRow(rowIndex);
            totalRow.getCell(1).value = 'TOTAL';
            totalRow.getCell(5).value = { formula: `SUM(E9:E${rowIndex - 1})` };
            totalRow.getCell(7).value = { formula: `SUM(G9:G${rowIndex - 1})` };
            totalRow.getCell(10).value = { formula: `SUM(J9:J${rowIndex - 1})` };
            totalRow.getCell(11).value = { formula: `SUM(K9:K${rowIndex - 1})` };
            totalRow.getCell(14).value = { formula: `SUM(N9:N${rowIndex - 1})` };
            totalRow.getCell(15).value = { formula: `SUM(O9:O${rowIndex - 1})` };
            totalRow.getCell(18).value = { formula: `SUM(R9:R${rowIndex - 1})` };
            totalRow.getCell(19).value = { formula: `SUM(S9:S${rowIndex - 1})` };
            totalRow.getCell(20).value = { formula: `SUM(T9:T${rowIndex - 1})` };
            totalRow.getCell(21).value = { formula: `SUM(U9:U${rowIndex - 1})` };
            totalRow.getCell(23).value = { formula: `SUM(W9:W${rowIndex - 1})` };
            totalRow.getCell(10).numFmt = '"R$ "#,##0.00';
            totalRow.getCell(11).numFmt = '"R$ "#,##0.00';
            totalRow.getCell(14).numFmt = '"R$ "#,##0.00';
            totalRow.getCell(15).numFmt = '"R$ "#,##0.00';
            totalRow.getCell(18).numFmt = '"R$ "#,##0.00';
            totalRow.getCell(19).numFmt = '"R$ "#,##0.00';
            totalRow.getCell(20).numFmt = '"R$ "#,##0.00';
            totalRow.getCell(21).numFmt = '"R$ "#,##0.00';
            totalRow.getCell(23).numFmt = '"R$ "#,##0.00';

            totalRow.eachCell({ includeEmpty: true }, (cell) => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'D3D3D3' } };
            });

            worksheet.pageSetup.orientation = 'landscape';

            // Generate and download Excel
            const buffer = await workbook.xlsx.writeBuffer();
            const blobExcel = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const linkExcel = document.createElement('a');
            linkExcel.href = URL.createObjectURL(blobExcel);
            linkExcel.download = `Precificação_${numeroProposta}_${new Date().toISOString().slice(0, 10)}.xlsx`;
            document.body.appendChild(linkExcel);
            linkExcel.click();
            document.body.removeChild(linkExcel);

            // Generate PDF if carrinho is valid
            await gerarPDF(carrinho);

        } catch (error) {
            console.error('Erro ao gerar Excel:', error);
            alert('Ocorreu um erro ao gerar o Excel. Verifique o console para mais detalhes.');
        }
    }
    async function gerarPDF(carrinho) {
    try {
        console.log('Iniciando geração de PDF. Estado do carrinho:', { carrinhoLength: carrinho.length });

        // Validação de entradas
        if (!carrinho || !Array.isArray(carrinho) || carrinho.length === 0) {
            console.warn('Carrinho inválido:', {
                exists: !!carrinho,
                isArray: Array.isArray(carrinho),
                length: carrinho?.length
            });
            alert('O carrinho está vazio ou não foi carregado. Adicione itens antes de gerar o PDF.');
            return;
        }

        if (!numeroProposta || !nomeEntidade || !cnpj) {
            alert('Preencha todos os campos obrigatórios: Número da Proposta, Entidade e CNPJ.');
            return;
        }

        if (typeof formatarMoeda !== 'function') {
            throw new Error('A função formatarMoeda não está definida.');
        }

        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
            throw new Error('A biblioteca jsPDF não foi carregada corretamente.');
        }
        const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

        // Definir margens
        const marginLeft = 40;
        const marginRight = 40;
        const marginTop = 40;
        const marginBottom = 40;
        const pageWidth = doc.internal.pageSize.width;
        const pageHeight = doc.internal.pageSize.height;

        // Página de Capa
        doc.setFillColor(240, 240, 240);
        doc.rect(0, 0, pageWidth, pageHeight, 'F');
        doc.setFontSize(28);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 51, 102);
        doc.text('Proposta de Precificação', pageWidth / 2, 160, { align: 'center' });
        doc.setFontSize(22);
        doc.text('Ministério do Esporte', pageWidth / 2, 200, { align: 'center' });
        doc.setFontSize(16);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(50, 50, 50);
        doc.text(`Proposta: ${numeroProposta || 'N/A'}`, pageWidth / 2, 260, { align: 'center' });
        doc.text(`Entidade: ${nomeEntidade || 'N/A'}`, pageWidth / 2, 280, { align: 'center' });
        doc.text(`CNPJ: ${cnpj || 'N/A'}`, pageWidth / 2, 300, { align: 'center' });
        doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, pageWidth / 2, 320, { align: 'center' });
        doc.addPage();

        // Cabeçalho da página principal
        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 51, 102);
        doc.text('Precificação - Ministério do Esporte', marginLeft, marginTop);
        doc.setLineWidth(2);
        doc.setDrawColor(0, 51, 102);
        doc.line(marginLeft, marginTop + 8, pageWidth - marginRight, marginTop + 8);

        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(50, 50, 50);
        doc.text(`Proposta: ${numeroProposta || 'N/A'}`, marginLeft, marginTop + 25);
        doc.text(`CNPJ: ${cnpj || 'N/A'}`, marginLeft, marginTop + 40);
        doc.text(`Entidade: ${nomeEntidade || 'N/A'}`, marginLeft, marginTop + 55);
        doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, marginLeft, marginTop + 70);

        // Cabeçalhos da tabela (removida a coluna "Menor Valor")
        const headers = [
            'Nº', 'Tipo', 'Item', 'Especificação/Justificativa', 'Qt d', 'Diárias/Meses', 'Total',
            'Razão/Link 1', 'CNPJ 1', 'Unitário 1', 'Total 1',
            'Razão/Link 2', 'CNPJ 2', 'Unitário 2', 'Total 2',
            'Razão/Link 3', 'CNPJ 3', 'Unitário 3', 'Total 3',
            'Unitário Def.', 'Total Def.'
        ];

        const subHeaders = [
            '', '', '', '', 'MEDIDAS', '', '', '1ª COTAÇÃO', '', '', '', '2ª COTAÇÃO', '', '', '', '3ª COTAÇÃO', '', '', '', 'COTAÇÃO DEFINIDA', ''
        ];

        // Dados da tabela (removida a coluna "Menor Valor")
        const data = carrinho.map((item, index) => {
            const totals = (item.empresas || []).map(e => e?.total || 0).filter(t => t > 0 && !isNaN(t));
            const menorValor = totals.length > 0 ? Math.min(...totals) : 0;
            const justificativa = (item.empresaSelecionada?.total || 0) > menorValor && menorValor !== 0 ? (item.justificativa || 'N/A') : '';
            const tipo = item.categoria?.toUpperCase() === 'SERVICOS' ? 'SERVIÇOS/RECURSOS HUMANOS' : (item.categoria?.toUpperCase() || 'N/A');
            const especificacaoJustificativa = `${item.descricao || 'N/A'}${justificativa ? '\nJustificativa: ' + justificativa : ''}`;
            return [
                item.id || index + 1,
                tipo,
                `${item.item || 'N/A'}${item.subitem ? ' - ' + item.subitem : ''}`,
                especificacaoJustificativa,
                item.quantidade || 0,
                item.periodo === 'N/A' ? 'N/A' : (item.periodo === 'diarias' ? 'Diárias' : 'Meses'),
                formatarMoeda(item.total || 0),
                item.empresas?.[0]?.nome && item.empresas?.[0]?.link ? `${item.empresas[0].nome} - ${item.empresas[0].link}` : (item.empresas?.[0]?.nome || ''),
                item.empresas?.[0]?.cnpj || '',
                formatarMoeda(item.empresas?.[0]?.unitario || 0),
                formatarMoeda(item.empresas?.[0]?.total || 0),
                item.empresas?.[1]?.nome && item.empresas?.[1]?.link ? `${item.empresas[1].nome} - ${item.empresas[1].link}` : (item.empresas?.[1]?.nome || ''),
                item.empresas?.[1]?.cnpj || '',
                formatarMoeda(item.empresas?.[1]?.unitario || 0),
                formatarMoeda(item.empresas?.[1]?.total || 0),
                item.empresas?.[2]?.nome && item.empresas?.[2]?.link ? `${item.empresas[2].nome} - ${item.empresas[2].link}` : (item.empresas?.[2]?.nome || ''),
                item.empresas?.[2]?.cnpj || '',
                formatarMoeda(item.empresas?.[2]?.unitario || 0),
                formatarMoeda(item.empresas?.[2]?.total || 0),
                formatarMoeda(item.empresaSelecionada?.unitario || 0),
                formatarMoeda(item.empresaSelecionada?.total || 0)
            ];
        });

        // Tabela principal com larguras ajustadas
        doc.autoTable({
            startY: marginTop + 90,
            head: [subHeaders, headers],
            body: data,
            theme: 'grid',
            styles: {
                font: 'helvetica',
                fontSize: 7, // Reduzido para 7pt
                cellPadding: 4, // Reduzido para 4pt
                overflow: 'linebreak',
                minCellHeight: 16,
                textColor: [40, 40, 40],
                lineColor: [180, 180, 180],
                lineWidth: 0.5
            },
            headStyles: {
                textColor: [255, 255, 255],
                fontStyle: 'bold',
                fontSize: 8, // Cabeçalho um pouco menor também
                halign: 'center',
                valign: 'middle',
                lineColor: [0, 51, 102],
                lineWidth: 0.5
            },
            columnStyles: {
                0: { cellWidth: 18, halign: 'center' }, // Nº
                1: { cellWidth: 35, halign: 'left' },   // Tipo
                2: { cellWidth: 40, halign: 'left' },   // Item
                3: { cellWidth: 70, halign: 'left' },   // Especificação/Justificativa
                4: { cellWidth: 20, halign: 'center' }, // Qt d
                5: { cellWidth: 35, halign: 'center' }, // Diárias/Meses
                6: { cellWidth: 25, halign: 'right' },  // Total
                7: { cellWidth: 40, halign: 'left', headFillColor: [135, 206, 250] },  // Razão/Link 1
                8: { cellWidth: 35, halign: 'center', headFillColor: [135, 206, 250] }, // CNPJ 1
                9: { cellWidth: 30, halign: 'right', headFillColor: [135, 206, 250] },  // Unitário 1
                10: { cellWidth: 30, halign: 'right', headFillColor: [135, 206, 250] }, // Total 1
                11: { cellWidth: 40, halign: 'left', headFillColor: [255, 255, 224] },  // Razão/Link 2
                12: { cellWidth: 35, halign: 'center', headFillColor: [255, 255, 224] }, // CNPJ 2
                13: { cellWidth: 30, halign: 'right', headFillColor: [255, 255, 224] },  // Unitário 2
                14: { cellWidth: 30, halign: 'right', headFillColor: [255, 255, 224] },  // Total 2
                15: { cellWidth: 40, halign: 'left', headFillColor: [144, 238, 144] },  // Razão/Link 3
                16: { cellWidth: 35, halign: 'center', headFillColor: [144, 238, 144] }, // CNPJ 3
                17: { cellWidth: 30, halign: 'right', headFillColor: [144, 238, 144] },  // Unitário 3
                18: { cellWidth: 30, halign: 'right', headFillColor: [144, 238, 144] },  // Total 3
                19: { cellWidth: 30, halign: 'right' },  // Unitário Def.
                20: { cellWidth: 30, halign: 'right' }   // Total Def.
            },
            alternateRowStyles: {
                fillColor: [245, 245, 245]
            },
            margin: { left: marginLeft, right: marginRight, bottom: marginBottom },
            didDrawPage: function (data) {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'italic');
                doc.setTextColor(100, 100, 100);
                doc.text(`Página ${doc.internal.getNumberOfPages() - 1}`, pageWidth - marginRight - 20, pageHeight - marginBottom + 10);
                doc.text('Ministério do Esporte - © 2025', marginLeft, pageHeight - marginBottom + 10);
            }
        });

        // Tabela de Totais
        const totalRow = [
            'TOTAL',
            '',
            '',
            '',
            carrinho.reduce((sum, item) => sum + (item.quantidade || 0), 0),
            '',
            formatarMoeda(carrinho.reduce((sum, item) => sum + (item.total || 0), 0)),
            '',
            '',
            formatarMoeda(carrinho.reduce((sum, item) => sum + (item.empresas?.[0]?.unitario || 0), 0)),
            formatarMoeda(carrinho.reduce((sum, item) => sum + (item.empresas?.[0]?.total || 0), 0)),
            '',
            '',
            formatarMoeda(carrinho.reduce((sum, item) => sum + (item.empresas?.[1]?.unitario || 0), 0)),
            formatarMoeda(carrinho.reduce((sum, item) => sum + (item.empresas?.[1]?.total || 0), 0)),
            '',
            '',
            formatarMoeda(carrinho.reduce((sum, item) => sum + (item.empresas?.[2]?.unitario || 0), 0)),
            formatarMoeda(carrinho.reduce((sum, item) => sum + (item.empresas?.[2]?.total || 0), 0)),
            formatarMoeda(carrinho.reduce((sum, item) => sum + (item.empresaSelecionada?.unitario || 0), 0)),
            formatarMoeda(carrinho.reduce((sum, item) => sum + (item.empresaSelecionada?.total || 0), 0))
        ];

        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 20,
            head: [],
            body: [totalRow],
            theme: 'grid',
            styles: {
                font: 'helvetica',
                fontSize: 7,
                cellPadding: 4,
                overflow: 'linebreak',
                minCellHeight: 16,
                textColor: [40, 40, 40],
                lineColor: [180, 180, 180],
                lineWidth: 0.5
            },
            bodyStyles: {
                fillColor: [230, 230, 230],
                textColor: [50, 50, 50],
                halign: 'center',
                valign: 'middle',
                fontStyle: 'bold'
            },
            columnStyles: {
                0: { cellWidth: 18, halign: 'center' },
                1: { cellWidth: 35, halign: 'left' },
                2: { cellWidth: 40, halign: 'left' },
                3: { cellWidth: 70, halign: 'left' },
                4: { cellWidth: 20, halign: 'center' },
                5: { cellWidth: 35, halign: 'center' },
                6: { cellWidth: 25, halign: 'right' },
                7: { cellWidth: 40, halign: 'left' },
                8: { cellWidth: 35, halign: 'center' },
                9: { cellWidth: 30, halign: 'right' },
                10: { cellWidth: 30, halign: 'right' },
                11: { cellWidth: 40, halign: 'left' },
                12: { cellWidth: 35, halign: 'center' },
                13: { cellWidth: 30, halign: 'right' },
                14: { cellWidth: 30, halign: 'right' },
                15: { cellWidth: 40, halign: 'left' },
                16: { cellWidth: 35, halign: 'center' },
                17: { cellWidth: 30, halign: 'right' },
                18: { cellWidth: 30, halign: 'right' },
                19: { cellWidth: 30, halign: 'right' },
                20: { cellWidth: 30, halign: 'right' }
            },
            margin: { left: marginLeft, right: marginRight, bottom: marginBottom }
        });

        // Salvar PDF
        const fileName = `Precificação_${numeroProposta || 'SemNúmero'}_${new Date().toISOString().slice(0, 10)}.pdf`;
        doc.save(fileName);

    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        alert(`Ocorreu um erro ao gerar o PDF: ${error.message}. Verifique o console para mais detalhes.`);
    }
}

carregarPlanilha();
});
    </script>
</body>
</html>